import sys
import csv
import os
import json

datadir = '/Users/dragonjohn/Documents/DevEnv/Python/MLCR2malwareDetect/dataset/'
#train_x = []
train_CSV_file = 'train.csv'
output_train_csv_file = 'train_data.csv'
output_test_csv_file = 'test_data.csv'

info_feature_selected = [1, 4, 7, 8, 9, 11, 12, 14, 18, 23, 26, 29, 30, 32, 33, 34]

if len(sys.argv)>=2:
    datadir = sys.argv[1]
else:
    print "no data set directory or output csv file name provided"

def select_info_feature():
    selected_label = []
    with open('info_label.txt', 'rb') as info_label_file:
        labels = info_label_file.readlines()
        for idx, row in enumerate(labels):
            if idx in info_feature_selected:
                selected_label.append(row.rstrip())
    return selected_label

def get_info_train_dataset(selected_features):
#    num = 0
    train_x = []
    train_x.append('label')
    train_x.extend(selected_features)
    with open(datadir + train_CSV_file, 'rb') as csvfile:
        spamreader = csv.reader(csvfile, delimiter = ',', quotechar='"')
        for row in spamreader:
            data_row = []
            data_row.append(row[1])
            with open(datadir + 'train/' + row[0] + '/info') as info_file:
                data = json.load(info_file)
                for key, value in data.items():
                    if key in selected_features:
                        data_row.append(value)
            train_x.append(data_row)
#            num += 1
#            if num > 10:
#                break
    return train_x


if __name__=='__main__':
    selected_features = select_info_feature()
    train_x = get_info_train_dataset(selected_features)
#    print train_x
    with open('dataset/' + output_train_csv_file,'wb') as train_output:
        writer = csv.writer( train_output, delimiter=",")
#        writer.writerow(['abc', 'bbb'])
        for row in train_x:
            writer.writerow(row)
